<div class="proposal-details">
  <!-- Header -->
  <div class="header">
    <div class="header-info">
      <button class="btn-back" (click)="goBack()">
        ‚Üê Powr√≥t
      </button>
      <h1>
        <span class="icon">üìã</span>
        Szczeg√≥≈Çy wniosku urlopowego #{{ proposalId }}
      </h1>
    </div>
    <div class="header-actions">
      <!-- Admin/HR/Manager actions -->
  <div *ngIf="canApprove && proposal?.status === 'SUBMITTED'" class="approval-actions">
        <button
          class="btn btn-success"
          (click)="showApprovalForm = true"
          [disabled]="proposal?.status !== 'SUBMITTED'"
        >
          ‚úÖ Zatwierd≈∫
        </button>
        <button
          class="btn btn-danger"
          (click)="showRejectionForm = true"
          [disabled]="proposal?.status !== 'SUBMITTED'"
        >
          ‚ùå Odrzuƒá
        </button>
      </div>

      <!-- User actions for own proposals -->
      <div *ngIf="canEditOwnProposal()" class="user-actions">
        <button
          class="btn btn-primary"
          (click)="editProposal()"
          [disabled]="proposal?.status !== 'SUBMITTED'"
        >
          ‚úèÔ∏è Edytuj wniosek
        </button>
        <button
          class="btn btn-secondary"
          (click)="withdrawProposal()"
          [disabled]="proposal?.status !== 'SUBMITTED'"
          title="Wycofaj wniosek"
        >
          ‚Ü©Ô∏è Wycofaj
        </button>
      </div>

      <!-- Debug info -->
      <div *ngIf="showDebugInfo" class="debug-info">
        <small>Debug: canApprove={{ canApprove }}, canEdit={{ canEditOwnProposal() }}</small>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>≈Åadowanie szczeg√≥≈Ç√≥w wniosku...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error" class="alert alert-error">
    <strong>‚ùå B≈ÇƒÖd:</strong><br>
    {{ error }}
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading && !error && proposal" class="main-content" [class.single-column]="proposal.status === 'APPROVED'">
  <!-- Left Panel - Proposal Details -->
  <div class="left-panel">
      <!-- Proposal Info Card -->
      <div class="card proposal-info">
        <div class="card-header">
          <h2>üìÑ Informacje o wniosku</h2>
          <span class="status-badge" [class]="getStatusClass(proposal.status)">
                {{ getStatusIcon(proposal.status) }} {{ getStatusLabel(proposal.status) }}
              </span>
        </div>
        <div class="card-content">
          <div class="info-grid">
            <div class="info-item">
              <span class="label">Pracownik:</span>
              <span class="value">{{ proposal.userFirstName }} {{ proposal.userLastName }}</span>
            </div>
            <div class="info-item">
              <span class="label">Typ urlopu:</span>
              <span class="value leave-type" [style.color]="getLeaveTypeColor(proposal.leaveType)">
                    {{ getLeaveTypeIcon(proposal.leaveType) }} {{ getLeaveTypeLabel(proposal.leaveType) }}
                  </span>
            </div>
            <div class="info-item">
              <span class="label">Okres:</span>
              <span class="value">
                    {{ formatDate(proposal.startDate) }} - {{ formatDate(proposal.endDate) }}
                  </span>
            </div>
            <div class="info-item">
              <span class="label">Liczba dni:</span>
              <span class="value days-count">{{ proposal.requestedDays }}</span>
            </div>
            <div class="info-item">
              <span class="label">Z≈Ço≈ºono:</span>
              <span class="value">{{ formatDateTime(proposal.submittedAt) }}</span>
            </div>
            <div class="info-item" *ngIf="proposal.processedAt">
              <span class="label">Rozpatrzono:</span>
              <span class="value">{{ formatDateTime(proposal.processedAt) }}</span>
            </div>
            <div class="info-item" *ngIf="proposal.processedByUserName">
              <span class="label">Rozpatrzy≈Ç:</span>
              <span class="value">{{ proposal.processedByUserName }}</span>
            </div>
          </div>
          <div class="description" *ngIf="proposal.description">
            <h3>üìù Opis wniosku</h3>
            <p>{{ proposal.description }}</p>
          </div>
          <div class="handover-notes" *ngIf="proposal.handoverNotes">
            <h3>üìã Uwagi do przekazania</h3>
            <p>{{ proposal.handoverNotes }}</p>
          </div>
          <div class="substitute" *ngIf="proposal.substituteUserName">
            <h3>üë§ Zastƒôpstwo</h3>
            <p>{{ proposal.substituteUserName }}</p>
          </div>
          <div class="rejection-reason" *ngIf="proposal.rejectionReason">
            <h3>‚ùå Pow√≥d odrzucenia</h3>
            <p>{{ proposal.rejectionReason }}</p>
          </div>
          <div class="approver-comments" *ngIf="proposal.approverComments">
            <h3>üí¨ Komentarz prze≈Ço≈ºonego</h3>
            <p>{{ proposal.approverComments }}</p>
          </div>
        </div>
      </div>
  <!-- Leave Statistics -->
  <div class="card stats-card" *ngIf="leaveStats && proposal?.status !== 'APPROVED'">
        <div class="card-header">
          <h2>üìä Statystyki urlopowe</h2>
        </div>
        <div class="card-content">
          <div class="stats-grid">
            <div class="stat-item">
              <span class="stat-value">{{ leaveStats.totalEmployees }}</span>
              <span class="stat-label">Wszyscy pracownicy</span>
            </div>
            <div class="stat-item">
              <span class="stat-value">{{ leaveStats.employeesOnLeave }}</span>
              <span class="stat-label">Na urlopie w tym okresie</span>
            </div>
            <div class="stat-item">
              <span class="stat-value">{{ getOverlapDaysCount() }}</span>
              <span class="stat-label">Dni z nak≈Çadaniem</span>
            </div>
          </div>
          <div class="overlapping-details">
            <h4>‚ö†Ô∏è Pracownicy na urlopie w tym samym czasie</h4>
            <div *ngIf="(leaveStats?.overlappingRequests && leaveStats.overlappingRequests.length > 0); else noOverlap">
              <div class="overlap-list">
                <div class="overlap-item" *ngFor="let overlap of leaveStats.overlappingRequests">
                  <span class="overlap-date">{{ formatDate(overlap.date) }}</span>
                  <div class="overlap-employees">
                        <span class="employee-chip" *ngFor="let emp of overlap.employees">
                          {{ emp.userFirstName }} {{ emp.userLastName }} ({{ getLeaveTypeLabel(emp.leaveType) }})
                        </span>
                  </div>
                </div>
              </div>
            </div>
            <ng-template #noOverlap>
              <p>Brak</p>
            </ng-template>
          </div>
        </div>
      </div>
      <!-- Work-time-like month table for approved proposals -->
      <div class="card month-card" *ngIf="proposal?.status === 'APPROVED'">
        <div class="card-header">
          <h2>üìÖ Widok miesiƒÖca</h2>
        </div>
        <div class="card-content">
          <div class="month-table-wrapper">
            <table class="month-table">
              <thead>
                <tr>
                  <th *ngFor="let d of monthDates()">{{ d.slice(-2) }}</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td *ngFor="let d of monthDates()"
                      [class.weekend]="isWeekend(d)"
                      [class.in-leave]="isInLeaveRange(d)"
                      [title]="isInLeaveRange(d) ? 'Urlop' : ''">
                    <div class="hours">&nbsp;</div>
                    <div class="leave" *ngIf="isInLeaveRange(d)">‚úì</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="selected-days-list" *ngIf="selectedDaysLabels().length > 0" style="margin-top:12px;">
            <strong>Urlop w dniach:</strong>
            <span class="chip" *ngFor="let d of selectedDaysLabels()">{{ d }}</span>
          </div>
        </div>
      </div>

  <!-- History -->
  <div class="card history-card">
        <div class="card-header">
          <h2>üìà Historia zmian</h2>
        </div>
        <div class="card-content">
          <div class="history-loading" *ngIf="historyLoading">
            <div class="spinner-small"></div>
            <span>≈Åadowanie historii...</span>
          </div>
          <div class="history-list" *ngIf="!historyLoading">
            <div class="history-item" *ngFor="let item of proposalHistory">
              <div class="history-icon">
                {{ getChangeTypeIcon(item.changeType) }}
              </div>
              <div class="history-content">
                <div class="history-header">
                  <span class="change-type">{{ getChangeTypeLabel(item.changeType) }}</span>
                  <span class="change-date">{{ formatDateTime(item.changedAt) }}</span>
                </div>
                <div class="history-details">
                  <span class="changed-by">{{ item.changedBy }}</span>
                  <span class="change-description" *ngIf="item.changeDescription">
                        {{ item.changeDescription }}
                      </span>
                </div>
              </div>
            </div>
            <div class="no-history" *ngIf="proposalHistory.length === 0">
              <p>Brak historii zmian</p>
            </div>
          </div>
        </div>
      </div>
    </div>

  <!-- Right Panel - Calendar -->
  <div class="right-panel" *ngIf="proposal?.status !== 'APPROVED'">
      <div class="card calendar-card">
        <div class="card-header">
          <h2>üìÖ PodglƒÖd urlop√≥w</h2>
          <div class="calendar-nav" style="display:flex; align-items:center; gap:8px; width:100%;">
            <div style="display:flex; align-items:center; gap:8px;">
              <span class="month-year">{{ getMonthYearDisplay() }}</span>
              <ng-container *ngIf="viewMode==='CALENDAR'">
                <button class="btn-nav" (click)="previousMonth()" title="Poprzedni miesiƒÖc">‚Äπ</button>
                <button class="btn-nav" (click)="nextMonth()" title="Nastƒôpny miesiƒÖc">‚Ä∫</button>
              </ng-container>
            </div>
            <div class="spacer"></div>
            <div class="view-toggle" style="display:flex; gap:4px;">
              <button class="btn" [class.btn-primary]="viewMode==='CALENDAR'" (click)="viewMode='CALENDAR'">Poka≈º w kalendarzu</button>
              <button class="btn" [class.btn-primary]="viewMode==='TABLE'" (click)="viewMode='TABLE'">Poka≈º w tabeli</button>
            </div>
          </div>
        </div>

        <!-- CALENDAR VIEW -->
        <ng-container *ngIf="viewMode==='CALENDAR'; else tableView">
          <div class="calendar-container">
            <div class="calendar-weekdays">
              <div class="weekday" *ngFor="let day of weekdays">{{ day }}</div>
            </div>

            <div class="calendar-days">
              <div
                class="calendar-day"
                *ngFor="let day of calendarDays"
                [class.other-month]="!day.isCurrentMonth"
                [class.today]="day.isToday"
                [class.in-range]="day.isInRange"
                [class.start-date]="day.isStartDate"
                [class.end-date]="day.isEndDate"
                [class.has-leaves]="day.hasLeaves"
              >
                <span class="day-number">{{ day.day }}</span>

                <div class="day-employees" *ngIf="day.employeesOnLeave.length > 0">
                  <div class="employee-tooltip">
                    <span class="employee-count">{{ day.employeesOnLeave.length }}</span>
                    <div class="tooltip-content">
                      <div class="tooltip-employee" *ngFor="let emp of day.employeesOnLeave">
                        <strong>{{ emp.userFirstName }} {{ emp.userLastName }}</strong>
                        <span class="emp-leave-type">{{ getLeaveTypeLabel(emp.leaveType) }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="calendar-legend">
            <div class="legend-item">
              <div class="legend-color current-proposal"></div>
              <span>Obecny wniosek</span>
            </div>
            <div class="legend-item">
              <div class="legend-color has-leaves"></div>
              <span>Inne urlopy</span>
            </div>
          </div>
        </ng-container>

        <!-- TABLE VIEW -->
        <ng-template #tableView>
          <div class="table-container">
            <table class="leave-table">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Dzie≈Ñ</th>
                  <th>Tw√≥j wniosek</th>
                  <th>Inne urlopy</th>
                  <th>Lista</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let day of tableDays()">
                  <td [class.other-month]="!day.isCurrentMonth">{{ formatDayLabel(day.date) }}</td>
                  <td>{{ weekdayLabel(day.date) }}</td>
                  <td>
                    <span *ngIf="day.isInRange" class="badge badge-proposal">‚úì</span>
                  </td>
                  <td>
                    <span *ngIf="day.employeesOnLeave.length > 0" class="badge">{{ day.employeesOnLeave.length }}</span>
                  </td>
                  <td>
                    <ng-container *ngIf="day.employeesOnLeave.length > 0; else dash">
                      <span class="chip" *ngFor="let emp of day.employeesOnLeave">
                        {{ emp.userFirstName }} {{ emp.userLastName }} ({{ getLeaveTypeLabel(emp.leaveType) }})
                      </span>
                    </ng-container>
                    <ng-template #dash>‚Äî</ng-template>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </ng-template>
      </div>
    </div>
  </div>

  <!-- Approval Form Modal -->
  <div class="modal" *ngIf="showApprovalForm" (click)="closeApprovalForm($event)">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>‚úÖ Zatwierd≈∫ wniosek urlopowy</h3>
        <button class="btn-close" (click)="closeApprovalForm()">&times;</button>
      </div>

      <form [formGroup]="approvalForm" (ngSubmit)="approveProposal()" class="modal-body">
        <div class="form-group">
          <label for="approverComments">üí¨ Komentarz (opcjonalnie):</label>
          <textarea
            id="approverComments"
            formControlName="approverComments"
            rows="4"
            placeholder="Dodaj komentarz do zatwierdzenia..."
          ></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="closeApprovalForm()">
            Anuluj
          </button>
          <button type="submit" class="btn btn-success" [disabled]="approvingProposal">
            <span *ngIf="approvingProposal" class="spinner-small"></span>
            ‚úÖ Zatwierd≈∫ wniosek
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Rejection Form Modal -->
  <div class="modal" *ngIf="showRejectionForm" (click)="closeRejectionForm($event)">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>‚ùå Odrzuƒá wniosek urlopowy</h3>
        <button class="btn-close" (click)="closeRejectionForm()">&times;</button>
      </div>

      <form [formGroup]="rejectionForm" (ngSubmit)="rejectProposal()" class="modal-body">
        <div class="form-group">
          <label for="rejectionReason">‚ùå Pow√≥d odrzucenia *:</label>
          <textarea
            id="rejectionReason"
            formControlName="rejectionReason"
            rows="4"
            placeholder="Wyja≈õnij pow√≥d odrzucenia wniosku..."
            required
          ></textarea>
          <div class="form-error" *ngIf="rejectionForm.get('rejectionReason')?.invalid && rejectionForm.get('rejectionReason')?.touched">
            Pow√≥d odrzucenia jest wymagany
          </div>
        </div>

        <div class="form-group">
          <label for="rejectionComments">üí¨ Dodatkowy komentarz (opcjonalnie):</label>
          <textarea
            id="rejectionComments"
            formControlName="approverComments"
            rows="3"
            placeholder="Dodatkowe uwagi lub sugestie..."
          ></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="closeRejectionForm()">
            Anuluj
          </button>
          <button type="submit" class="btn btn-danger" [disabled]="rejectingProposal || rejectionForm.invalid">
            <span *ngIf="rejectingProposal" class="spinner-small"></span>
            ‚ùå Odrzuƒá wniosek
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Success Message -->
  <div class="alert alert-success" *ngIf="successMessage">
    <strong>‚úÖ Sukces:</strong><br>
    {{ successMessage }}
  </div>
</div>
