<div class="container" *ngIf="!loading(); else loadingTpl">
  <ng-container *ngIf="record() as r; else errorTpl">
    <div class="header">
      <button class="back" (click)="router.navigate(['/work-time-records'])">‚Üê Wr√≥ƒá</button>
      <h2>Ewidencja: {{ r.periodDisplay }}</h2>
      <div class="status">
        <span class="badge">{{ statusLabel(r.status) }}</span>
      </div>
    </div>

    <div class="grid">
      <div class="card wide">
        <h3>Tabela (miesiƒÖc)</h3>
        <div class="muted" *ngIf="daysLoading()">≈Åadowanie dni‚Ä¶</div>
        <div class="table-wrapper" *ngIf="!daysLoading()">
          <table class="month-table">
            <thead>
              <tr>
                <th *ngFor="let d of monthDates()">{{ d.slice(-2) }}</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td *ngFor="let d of monthDates()" [class.weekend]="isWeekend(d)" [title]="dayTooltip(d)" aria-label="{{ dayTooltip(d) }}">
                  <div class="hours">
                    {{ dayInfo(d).hours !== null ? (dayInfo(d).hours | number:'1.0-1') + ' h' : '‚Äî' }}
                  </div>
                  <div class="leave" *ngIf="dayInfo(d).isLeave">üèñÔ∏è</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <h3>Podsumowanie</h3>
        <ul>
          <li>Zaplanowane: <strong>{{ r.scheduledHours | number:'1.2-2' }} h</strong></li>
          <li>Urlopy: <strong>{{ r.leaveHours | number:'1.2-2' }} h</strong></li>
          <li>Razem: <strong>{{ r.totalHours | number:'1.2-2' }} h</strong></li>
        </ul>
      </div>

      <div class="card actions">
        <h3>Akcje</h3>
        <div class="buttons">
          <!-- Owner can submit when status is WAITING -->
          <button *ngIf="canSubmitForApproval()" [disabled]="actionLoading()" (click)="acceptByUser()">ÔøΩ Wy≈õlij do akceptacji</button>
          <!-- HR can accept/reject when USER_ACCEPTED -->
          <ng-container *ngIf="canHrDecide()">
            <button [disabled]="actionLoading()" (click)="acceptBySupervisor()">‚úÖ Akceptuj</button>
            <button class="danger" [disabled]="actionLoading()" (click)="showRejectModal.set(true)">‚ùå Odrzuƒá</button>
          </ng-container>
        </div>
      </div>

      <div class="card">
        <h3>Aneksy</h3>
        <button class="link" (click)="toggleAnnexForm()">{{ showAnnexForm() ? '‚Äì' : '+' }} Dodaj aneks</button>
        <form *ngIf="showAnnexForm()" (ngSubmit)="submitAnnex()" class="annex-form">
          <label>Data korekty
            <input type="date" [(ngModel)]="annex.correctionDate" name="correctionDate" required />
          </label>
          <label>Skorygowane godziny
            <input type="number" [(ngModel)]="annex.correctedHours" name="correctedHours" step="0.25" min="0" max="24" required />
          </label>
          <label>Pow√≥d
            <textarea [(ngModel)]="annex.reason" name="reason" required minlength="10"></textarea>
          </label>
          <button type="button" (click)="toggleAnnexForm()">Anuluj</button>
          <button type="submit" [disabled]="actionLoading()">Zapisz aneks</button>
        </form>

        <table class="annexes" *ngIf="r.annexes?.length">
          <thead>
            <tr>
              <th>Data</th>
              <th>Godziny</th>
              <th>Pow√≥d</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let a of r.annexes">
              <td>{{ a.correctionDate }}</td>
              <td>{{ a.correctedHours }}</td>
              <td>{{ a.reason }}</td>
              <td>{{ a.status }}</td>
            </tr>
          </tbody>
        </table>
        <div *ngIf="!r.annexes || !r.annexes.length" class="muted">Brak aneks√≥w</div>
      </div>

      <div class="card">
        <h3>Historia</h3>
        <a [routerLink]="['/work-time-records']">Zobacz wszystkie moje zmiany</a>
      </div>
    </div>
  </ng-container>
</div>

<!-- Reject modal -->
<div class="modal-backdrop" *ngIf="showRejectModal()"></div>
<div class="modal" *ngIf="showRejectModal()">
  <div class="modal-content">
    <h3>Odrzuƒá ewidencjƒô</h3>
    <p>Podaj pow√≥d odrzucenia (min. 10 znak√≥w):</p>
    <textarea [(ngModel)]="rejectReason" placeholder="Pow√≥d odrzucenia"></textarea>
    <div class="modal-actions">
      <button (click)="showRejectModal.set(false)">Anuluj</button>
      <button class="danger" (click)="reject()">Odrzuƒá</button>
    </div>
  </div>
  </div>

<ng-template #loadingTpl>
  <div class="container loading">≈Åadowanie...</div>
</ng-template>

<ng-template #errorTpl>
  <div class="container error">{{ error() }}</div>
</ng-template>
