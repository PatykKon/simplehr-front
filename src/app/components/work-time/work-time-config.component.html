<div class="wtc-container" *ngIf="!loading(); else loadingTpl">
  <div class="wtc-layout">
    <aside class="wtc-sidebar">
      <div class="wtc-title">Ewidencja czasu</div>
      <nav class="wtc-nav">
        <a routerLink="/work-time" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }">
          <span class="icon">üìÖ</span>
          Widok miesiƒÖca
        </a>
        <a routerLink="/work-time/config" routerLinkActive="active">
          <span class="icon">‚öôÔ∏è</span>
          Konfiguracja
        </a>
        <a routerLink="/work-time-records" routerLinkActive="active">
          <span class="icon">üóÇÔ∏è</span>
          Moja ewidencja
        </a>
        <a routerLink="/leave-requests" routerLinkActive="active">
          <span class="icon">üìù</span>
          Wnioski
        </a>
        <a *ngIf="auth.hasAnyRole(['ROLE_ADMIN','ROLE_HR'])" routerLink="/admin/work-time" routerLinkActive="active">
          <span class="icon">üóìÔ∏è</span>
          Przelicz dni
        </a>
      </nav>

      <div class="wtc-sidebar-card" *ngIf="config() as c">
        <div class="label">Aktywny tryb</div>
        <div class="mode-badge" [class.punch]="isPunch()" [class.manual]="isManual()" [class.schedule]="isSchedule()">
          {{ modeLabel() }}
        </div>
      </div>
    </aside>

    <main class="wtc-main">
      <div class="wtc-header">
        <h2>‚öôÔ∏è Konfiguracja ewidencji czasu pracy</h2>
      </div>

      <!-- Active config details if present -->
      <section class="card" *ngIf="config()">
        <div class="row">
          <div>
            <div class="label">Aktywna konfiguracja</div>
            <div class="name">{{ config()?.name || '‚Äî' }}</div>
            <div class="desc" *ngIf="config()?.description">{{ config()?.description }}</div>
          </div>
          <!-- Removed duplicate Tryb display to avoid repetition (mode shown in sidebar) -->
        </div>
      </section>

      <!-- Warning if no active config -->
      <section class="card warn" *ngIf="!config()">
        <h3>Brak aktywnej konfiguracji</h3>
        <p>Nie znaleziono WorkTimeConfig z flagƒÖ <code>active=true</code>. Jako uprawniony u≈ºytkownik mo≈ºesz utworzyƒá nowƒÖ konfiguracjƒô poni≈ºej.</p>
      </section>

    <section class="card" *ngIf="auth.hasAnyRole(['ROLE_ADMIN','ROLE_HR','ROLE_MANAGER'])">
      <h3>Nowa konfiguracja</h3>
      <p class="desc">Utw√≥rz konfiguracjƒô zgodnƒÖ z API. Zaznaczenie ‚ÄûAktywna‚Äù mo≈ºe spowodowaƒá konflikt, je≈õli istnieje ju≈º aktywna konfiguracja (wtedy backend zwr√≥ci 409).</p>
      <form (ngSubmit)="submitNewConfig()" #cfgForm="ngForm">
        <div class="form-grid">
          <label>
            Nazwa
            <input type="text" name="name" [ngModel]="newConfig().name" (ngModelChange)="updateNewConfig({name: $event})" required />
          </label>

          <label>
            Opis
            <input type="text" name="description" [ngModel]="newConfig().description" (ngModelChange)="updateNewConfig({description: $event})" />
          </label>

          <label>
            Tryb
            <select name="workTimeType" [ngModel]="newConfig().workTimeType" (ngModelChange)="onTypeChange($event)" required>
              <option value="SCHEDULE_WORK">SCHEDULE_WORK</option>
              <option value="PUNCH_IN_OUT">PUNCH_IN_OUT</option>
              <option value="MANUAL_ENTRY">MANUAL_ENTRY</option>
            </select>
          </label>

          <label class="checkbox">
            <input type="checkbox" name="active" [ngModel]="newConfig().active" (ngModelChange)="updateNewConfig({active: $event})" /> Aktywna
          </label>

          <label class="checkbox">
            <input type="checkbox" name="autoMarkLeaveDays" [ngModel]="newConfig().autoMarkLeaveDays" (ngModelChange)="updateNewConfig({autoMarkLeaveDays: $event})" /> Auto‚Äëoznaczanie dni urlopu
          </label>

          <label class="checkbox">
            <input type="checkbox" name="allowCorrections" [ngModel]="newConfig().allowCorrections" (ngModelChange)="updateNewConfig({allowCorrections: $event})" /> Pozw√≥l na korekty
          </label>

          <label>
            Limit dni na korekty
            <input type="number" name="correctionDaysLimit" min="0" max="365" [ngModel]="newConfig().correctionDaysLimit" (ngModelChange)="updateNewConfig({correctionDaysLimit: $event})" />
          </label>

          <div class="approvers">
            <label>
              AkceptujƒÖcy
              <input list="approverList" name="approverPick" [ngModel]="approverPick()" (ngModelChange)="onApproverPickChange($event)" placeholder="Wybierz osobƒô z listy" />
              <datalist id="approverList">
                <option *ngFor="let u of eligibleApprovers()" [value]="u.id">{{ approverLabel(u) }}</option>
              </datalist>
            </label>
            <div class="chips" *ngIf="selectedApproverIds().length > 0">
              <span class="chip" *ngFor="let id of selectedApproverIds()">
                {{ approverLabelById(id) }}
                <button type="button" class="chip-x" (click)="removeApprover(id)" aria-label="Usu≈Ñ">√ó</button>
              </span>
            </div>
          </div>

          <ng-container *ngIf="newConfig().workTimeType === 'PUNCH_IN_OUT'">
            <label class="checkbox">
              <input type="checkbox" name="autoRoundEnabled" [ngModel]="newConfig().autoRoundEnabled" (ngModelChange)="updateNewConfig({autoRoundEnabled: $event})" /> ZaokrƒÖglanie w≈ÇƒÖczone
            </label>
            <label>
              Minuty zaokrƒÖglenia
              <input type="number" name="roundingMinutes" min="1" max="60" [ngModel]="newConfig().roundingMinutes" (ngModelChange)="updateNewConfig({roundingMinutes: $event})" />
            </label>
          </ng-container>

          <ng-container *ngIf="newConfig().workTimeType === 'MANUAL_ENTRY'">
            <label>
              Maks. godziny dziennie
              <input type="number" name="maxDailyHours" min="0" max="24" step="0.25" [ngModel]="newConfig().maxDailyHours" (ngModelChange)="updateNewConfig({maxDailyHours: $event})" />
            </label>
            <label>
              Maks. nadgodziny dziennie
              <input type="number" name="maxDailyOvertimeHours" min="0" max="24" step="0.25" [ngModel]="newConfig().maxDailyOvertimeHours" (ngModelChange)="updateNewConfig({maxDailyOvertimeHours: $event})" />
            </label>
          </ng-container>
        </div>

        <div class="actions">
          <button type="submit" class="btn" [disabled]="creating() || !cfgForm.form.valid">Zapisz konfiguracjƒô</button>
        </div>
      </form>
    </section>

  <!-- Mode details if config available -->
    <section class="grid" *ngIf="config()">
      <div class="card">
        <h3>Regu≈Çy og√≥lne</h3>
        <ul class="props">
          <li><span>Auto‚Äëoznaczanie dni urlopu:</span> <b>{{ config()?.autoMarkLeaveDays ? 'TAK' : 'NIE' }}</b></li>
          <li><span>Pozw√≥l na korekty:</span> <b>{{ config()?.allowCorrections ? 'TAK' : 'NIE' }}</b></li>
          <li><span>Limit dni na korekty:</span> <b>{{ config()?.correctionDaysLimit ?? '‚Äî' }}</b></li>
          <li><span>AkceptujƒÖcy (IDs):</span> <b>{{ (config()?.approverUserIds || []).join(', ') || '‚Äî' }}</b></li>
        </ul>
      </div>

      <div class="card" *ngIf="isPunch()">
        <h3>Tryb PUNCH</h3>
        <ul class="props">
          <li><span>ZaokrƒÖglanie w≈ÇƒÖczone:</span> <b>{{ config()?.autoRoundEnabled ? 'TAK' : 'NIE' }}</b></li>
          <li><span>Minuty zaokrƒÖglenia:</span> <b>{{ config()?.roundingMinutes ?? 15 }}</b></li>
          <li class="hint">W UI pokazuj roundedHours je≈õli dostƒôpne i dodaj tooltip ‚ÄûzaokrƒÖglono do X min‚Äù.</li>
        </ul>
      </div>

      <div class="card" *ngIf="isManual()">
        <h3>Tryb MANUAL</h3>
        <ul class="props">
          <li><span>Maks. godziny dziennie:</span> <b>{{ config()?.maxDailyHours ?? '‚Äî' }}</b></li>
          <li><span>Maks. nadgodziny dziennie:</span> <b>{{ config()?.maxDailyOvertimeHours ?? '‚Äî' }}</b></li>
          <li class="hint">Blokuj przysz≈Çe daty i waliduj limity po stronie FE.</li>
        </ul>
      </div>

      <div class="card" *ngIf="isSchedule()">
        <h3>Tryb SCHEDULE_WORK</h3>
        <p>Widok jest tylko‚Äëdo‚Äëodczytu (po publikacji grafiku). Po ponownej publikacji od≈õwie≈º miesiƒÖc/dzie≈Ñ.</p>
      </div>
    </section>

    <!-- Removed duplicated create form to avoid repetition -->

    <!-- List all configs (bez aktywacji z tej strony) -->
    <section class="card" *ngIf="auth.hasAnyRole(['ADMIN','HR','MANAGER'])">
      <div class="examples-header">
        <h3>Dostƒôpne konfiguracje</h3>
        <button class="btn" type="button" (click)="refreshConfigs()">Od≈õwie≈º</button>
      </div>
      <div *ngIf="configsLoading()" class="loading">≈Åadowanie‚Ä¶</div>
      <div *ngIf="!configsLoading() && configs().length === 0" class="muted">Brak konfiguracji</div>
      <ul class="props" *ngIf="configs().length > 0">
        <li *ngFor="let c of configs()">
          <span>{{ c.name }} ‚Äî {{ c.workTimeType }}</span>
          <span><span class="mode-badge" *ngIf="c.active">Aktywna</span></span>
        </li>
      </ul>
    </section>

    <!-- Examples for FE -->
    <section class="card examples" *ngIf="auth.hasAnyRole(['ADMIN','HR','MANAGER'])">
      <div class="examples-header">
        <h3>Przyk≈Çady API i payloady</h3>
        <button class="btn" (click)="showExamples.set(!showExamples())">{{ showExamples() ? 'Ukryj' : 'Poka≈º' }}</button>
      </div>
      <div *ngIf="showExamples()">
          <div ngNonBindable>
        <h4>Detekcja trybu</h4>
          <pre ngNonBindable>// GET /api/work-time-configs ‚Üí wybierz active=true
          [
            &#123;
              "id": 1,
              "name": "Domy≈õlna",
              "workTimeType": "PUNCH_IN_OUT",
              "active": true,
              "autoRoundEnabled": true,
              "roundingMinutes": 15,
              "allowCorrections": true,
              "correctionDaysLimit": 7
            &#125;
          ]</pre>

        <h4>Widok miesiƒÖca</h4>
          <pre ngNonBindable>// GET /api/work-time/days?period=2025-10
          [
            &#123; "workDate":"2025-10-01", "scheduledStartTime":"09:00", "scheduledEndTime":"17:00", "editable": false, "leaveDay": false &#125;,
            &#123; "workDate":"2025-10-02", "punchInTime":"09:02", "punchOutTime":"17:05", "roundedHours": 8.0, "editable": true, "leaveDay": false &#125;,
            &#123; "workDate":"2025-10-03", "standardHours": 8.0, "overtimeHours": 1.0, "editable": true, "leaveDay": false &#125;
          ]</pre>

        <h4>Punch</h4>
          <pre ngNonBindable>// POST /api/work-time/punch/in
          &#123; "workDate": "2025-10-28" &#125;
// POST /api/work-time/punch/out
          &#123; "workDate": "2025-10-28" &#125;</pre>

        <h4>Manual Day</h4>
          <pre ngNonBindable>// PUT /api/work-time/manual/day
          &#123; "workDate":"2025-10-28", "standardHours":8.0, "overtimeHours":1.0, "note":"Projekt X" &#125;</pre>

        <h4>Model b≈Çƒôdu</h4>
          <pre ngNonBindable>&#123;
            "timestamp":"2025-10-28T10:15:30.123Z",
            "code":"BAD_REQUEST",
            "message":"Przekroczono dozwolone godziny dzienne",
            "path":"/api/work-time/manual/day",
            "correlationId":"a1b2c3...",
            "details": &#123; "standardHours": "max 8", "overtimeHours": "max 2" &#125;
          &#125;</pre>
          </div>
      </div>
    </section>
    </main>
  </div>
</div>

<ng-template #loadingTpl>
  <div class="loading">≈Åadowanie konfiguracji‚Ä¶</div>
  </ng-template>

<ng-template #emptyCfg></ng-template>