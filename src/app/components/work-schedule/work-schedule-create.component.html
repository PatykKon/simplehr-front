<div class="ws-create-container">
  <div class="header">
    <button class="btn btn-link" (click)="goBackToList()">← Wróć do listy</button>
    <h1>Nowy grafik</h1>
  </div>

  <!-- Step 1: Create schedule basic info -->
  @if (!schedule()) {
    <form class="create-form" [formGroup]="scheduleForm" (ngSubmit)="createSchedule()">
      <div class="form-row">
        <label>Miesiąc</label>
        <div class="month-row">
          <select class="form-control" name="monthSelect" [(ngModel)]="monthSelectorValue" [ngModelOptions]="{ standalone: true }">
            <option *ngFor="let m of months" [ngValue]="m.value">{{ m.label }}</option>
          </select>
          <select class="form-control" name="yearSelect" [(ngModel)]="yearSelectorValue" [ngModelOptions]="{ standalone: true }">
            <option *ngFor="let y of years()" [ngValue]="y">{{ y }}</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <label>Nazwa</label>
        <input type="text" class="form-control" formControlName="name" (input)="onNameInput()" placeholder="Np. Grafik listopad 2025" />
        @if (scheduleForm.get('name')?.touched && scheduleForm.get('name')?.invalid) {
          <div class="error">Podaj nazwę (min. 3 znaki)</div>
        }
      </div>

      <div class="form-row">
        <label>Opis (opcjonalnie)</label>
        <textarea class="form-control" formControlName="description" rows="2"></textarea>
      </div>

      <div class="form-row grid-2">
        <div>
          <label>Data od</label>
          <input type="date" class="form-control" formControlName="startDate" [disabled]="true" />
        </div>
        <div>
          <label>Data do</label>
          <input type="date" class="form-control" formControlName="endDate" [disabled]="true" />
        </div>
      </div>

      @if (createError()) {
        <div class="error">{{ createError() }}</div>
      }

      <div class="actions">
        <button class="btn btn-primary" type="submit" [disabled]="creating()">Utwórz i edytuj</button>
      </div>
    </form>
  }

  <!-- Step 2: Editor with calendar and employees -->
  @if (schedule()) {
    <div class="editor" [class.table-mode]="viewMode() === 'TABLE'">
      <div class="calendar">
        <div class="calendar-actions-top">
          <button class="btn" type="button" (click)="goBackToList()">Wróć do listy</button>
          <input class="form-control filter-input" type="text" placeholder="Filtruj po osobie (imię i nazwisko)" [ngModel]="employeeCalendarFilter()" (ngModelChange)="onFilterInputChange($event)" />
          <button class="btn" type="button" (click)="clearCalendarFilter()">Wyczyść</button>
          @if (viewMode() === 'CALENDAR') {
            <label style="display:flex; align-items:center; gap:6px; font-size:0.95rem; color:#334155; margin-left:8px;">
              <input type="checkbox" [ngModel]="mergeRanges()" (ngModelChange)="mergeRanges.set($event); refreshCalendarEvents()" />
              Scal zakresy
            </label>
          }
          <div class="view-toggle" style="margin-left:12px; display:flex; gap:4px;">
            <button class="btn" [class.btn-primary]="viewMode() === 'CALENDAR'" type="button" (click)="viewMode.set('CALENDAR')">Kalendarz</button>
            <button class="btn" [class.btn-primary]="viewMode() === 'TABLE'" type="button" (click)="viewMode.set('TABLE')">Tabela</button>
          </div>
          @if (hasAnyLeaves()) {
            <div class="legend-compact">
              <span class="legend-dot leave"></span>
              Urlopy
            </div>
          }
          @if (viewMode() === 'TABLE' && isMobile()) {
            <div class="mobile-week-nav" style="display:flex; align-items:center; gap:6px; margin-left:8px;">
              <button class="btn" type="button" (click)="prevTableWeek()">◀ 7 dni</button>
              <span style="font-size:0.9rem; color:#334155; min-width:110px; text-align:center;">{{ getTableWeekLabel() }}</span>
              <button class="btn" type="button" (click)="nextTableWeek()">7 dni ▶</button>
            </div>
          }
          <div class="spacer"></div>
          <button class="btn btn-success" type="button" (click)="submitCurrentSchedule()">Zapisz i wyślij do akceptacji</button>
        </div>
        @if (viewMode() === 'CALENDAR') {
          <full-calendar #calendar [options]="calendarOptions()"></full-calendar>
        } @else if (viewMode() === 'TABLE') {
          <div class="table-view">
            @let dates = getVisibleDates();
            @if (showTableTopScrollbar()) {
              <div class="table-scrollbar" #tableTopScroll (scroll)="onTableScroll($event, 'TOP')" [class.has-shadow]="tableTopHasShadow()">
                <div class="scroll-spacer" [style.width.px]="tableScrollWidth()"></div>
              </div>
            }
            <div class="ws-table" #tableMainScroll (scroll)="onTableScroll($event, 'MAIN')">
              <table #scheduleTable>
                <thead>
                  <tr>
                    <th class="emp sticky">Pracownik</th>
                    @for (d of dates; track d.date) {
                      <th class="day" [class.sat]="isSaturdayDate(d.date)" [class.sun]="isSundayDate(d.date)" [class.holiday]="isHolidayDate(d.date)">{{ d.day }}</th>
                    }
                  </tr>
                </thead>
                <tbody>
                  @for (emp of getTableEmployees(); track emp.id) {
                    @let fullName = (emp.firstName + ' ' + emp.lastName).trim() || emp.username;
                    <tr>
                      <td class="emp sticky">
                        <div class="name-stack">
                          <div class="first">{{ emp.firstName }}</div>
                          <div class="last">{{ emp.lastName }}</div>
                        </div>
                      </td>
                      @for (d of dates; track d.date) {
                          @let entry = getEntryFor(emp.id, d.date);
                          @let leaves = getLeavesFor(emp.id, d.date);
                        <td class="day"
                          (click)="onTableCellClick(emp.id, fullName, d.date)"
                          [class.sat]="isSaturdayDate(d.date)"
                          [class.sun]="isSundayDate(d.date)"
                            [class.holiday]="isHolidayDate(d.date)"
                            [class.leave-cell]="leaves.length > 0"
                            [class.leave-conflict]="leaves.length > 0 && !!entry"
                            [title]="leaves.length ? leaveTooltip(leaves) : ''"
                          >
                          @if (entry) {
                            <div class="cell-time">
                              <div class="start">{{ formatDisplayHM(entry.startTime) }}</div>
                              <div class="end">{{ formatDisplayHM(entry.endTime) }}</div>
                            </div>
                          }
                            @if (!entry && leaves.length === 0) {
                              <span style="color:#94a3b8;">—</span>
                            }
                            @if (leaves.length) {
                              <div class="cell-leave">
                                <span class="leave-dot"></span>
                                {{ formatLeaveTypes(leaves) }}
                              </div>
                            }
                        </td>
                      }
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        }
        <div class="calendar-actions-bottom">
          <button class="btn" type="button" (click)="goBackToList()">Zapisz jako szkic i wróć</button>
          <div class="spacer"></div>
          <button class="btn btn-success" type="button" (click)="submitCurrentSchedule()">Wyślij do akceptacji</button>
        </div>
      </div>
      <div class="sidebar">
        <h3>Pracownicy</h3>
        @if (schedule()) {
          <div class="workload-summary">
            <div class="summary-header">
              <div>
                <span class="summary-title">Bilans miesiąca</span>
                <span class="summary-month">{{ getCurrentMonthLabel() }}</span>
              </div>
              <button class="btn btn-sm btn-outline" type="button" (click)="resetMonthlyHoursTarget()">Ustaw domyślne</button>
            </div>
            <div class="summary-field">
              <label>Godziny do zaplanowania</label>
              <input type="number" class="form-control" min="0" step="0.5" [ngModel]="monthlyHoursTarget()" (ngModelChange)="updateMonthlyHoursTarget($event)" />
            </div>
            <p class="summary-note">Szczegóły zaplanowanych godzin i urlopów znajdziesz przy każdym pracowniku.</p>
            @if (leavesLoading()) {
              <p class="summary-note">Ładuję dane urlopowe...</p>
            }
          </div>
        }
        <input type="text" class="form-control" placeholder="Szukaj..." [ngModel]="employeeSearch()" (ngModelChange)="employeeSearch.set($event)" />

        <div class="employee-list">
          @for (emp of filteredEmployees(); track emp.id) {
            @let stats = getEmployeeStats(emp.id);
            <div class="employee-item" [class.selected]="selectedEmployeeId() === emp.id" (click)="selectEmployee(emp)">
              <div class="name">{{ emp.firstName }} {{ emp.lastName }}</div>
              <div class="stats">
                <span>
                  Zaplanowano: <strong>{{ (stats?.plannedHours ?? 0) | number:'1.0-1' }} h</strong>
                </span>
                @let hoursRemaining = stats?.hoursRemaining;
                @if (hoursRemaining !== null && hoursRemaining !== undefined) {
                  @if (hoursRemaining > 0) {
                    <span>Pozostało: <strong>{{ hoursRemaining | number:'1.0-1' }} h</strong></span>
                  } @else if (hoursRemaining < 0) {
                    <span class="over-limit">Przekroczono o <strong>{{ (hoursRemaining * -1) | number:'1.0-1' }} h</strong></span>
                  } @else {
                    <span>Bilans na zero</span>
                  }
                }
                <span>
                  Urlopy: <strong>{{ stats?.leaveDays ?? 0 }}</strong>
                  @if (stats?.leaveDates?.length) {
                    ({{ formatDateList(stats!.leaveDates) }})
                  } @else {
                    (brak)
                  }
                </span>
              </div>
              <div class="actions-inline">
                <button class="btn btn-sm" type="button" (click)="$event.stopPropagation(); openTemplateModalForEmployee(emp)">Użyj szablonu</button>
              </div>
            </div>
          }
        </div>

        <div class="hint">
          Wybierz pracownika, a następnie kliknij dzień w kalendarzu, aby dodać godziny pracy.
        </div>
      </div>
    </div>
  }

  <!-- Add entry modal -->
  @if (showAddModal()) {
    <div class="modal-backdrop" (click)="cancelAddEntry()"></div>
    <div class="modal" [class.wide]="showLargeDatePicker()">
      <h3>Dodaj godziny</h3>
      <div class="modal-body">
        <div class="row">
          <label>Data</label>
          <input type="date" class="form-control" [ngModel]="addDate()" (ngModelChange)="addDate.set($event)" />
          <button class="btn btn-outline" type="button" (click)="toggleLargePicker()">{{ showLargeDatePicker() ? 'Ukryj duży kalendarz' : 'Duży kalendarz' }}</button>
        </div>
        @if (showLargeDatePicker()) {
          <div class="date-picker">
            <div class="dp-header">
              <div>Pn</div><div>Wt</div><div>Śr</div><div>Cz</div><div>Pt</div><div>So</div><div>Nd</div>
            </div>
            <div class="dp-weeks">
              @for (w of pickerWeeks(); track $index) {
                <div class="dp-row">
                  @for (d of w; track $index) {
                    <div class="dp-cell" [class.empty]="!d" [class.sat]="d && isSaturdayDate(d)" [class.sun]="d && isSundayDate(d)" [class.holiday]="d && isHolidayDate(d)" [class.selected]="d && isPickerSelected(d)" (click)="d && selectPickerDate(d)">
                      {{ d ? (d.slice(-2)) : '' }}
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        }
        <div class="row grid-2">
          <div>
            <label>Od</label>
            <input type="time" class="form-control" [ngModel]="addStartTime()" (ngModelChange)="addStartTime.set($event)" />
          </div>
          <div>
            <label>Do</label>
            <input type="time" class="form-control" [ngModel]="addEndTime()" (ngModelChange)="addEndTime.set($event)" />
          </div>
        </div>
        <div class="row">
          <label class="checkbox">
            <input type="checkbox" [checked]="addOvertime()" (change)="addOvertime.set($event.target.checked)" /> Nadgodziny
          </label>
        </div>
        @if (addError()) {
          <div class="error">{{ addError() }}</div>
        }
      </div>
      <div class="modal-actions">
        <button class="btn" (click)="cancelAddEntry()">Anuluj</button>
        <button class="btn btn-primary" (click)="confirmAddEntry()">Dodaj</button>
      </div>
    </div>
  }

  <!-- Use template modal -->
  @if (showTemplateModal()) {
    <div class="modal-backdrop" (click)="closeTemplateModal()"></div>
    <div class="modal">
      <h3>Użyj szablonu dla: {{ templateEmployeeName() }}</h3>
      <div class="modal-body">
        <div class="row">
          <label>Konfiguracja</label>
          <select class="form-control" [ngModel]="selectedConfigId()" (ngModelChange)="selectedConfigId.set($event); onTemplateConfigChange()">
            @for (c of configs(); track c.id) {
              <option [value]="c.id">{{ c.name }} ({{ c.type }})</option>
            }
          </select>
        </div>
        <div class="row grid-2">
          <div>
            <label>Start od dnia miesiąca</label>
            <input type="number" class="form-control" min="1" max="31" [ngModel]="templateStartDay()" (ngModelChange)="templateStartDay.set($event)" />
          </div>
          <div>
            <label>Początek wzorca</label>
            <select class="form-control" [disabled]="templateMaxPositions() <= 1" [ngModel]="templateStartPosition()" (ngModelChange)="templateStartPosition.set($event)">
              @for (i of [].constructor(templateMaxPositions()); track i) {
                <option [value]="i+1">Pozycja {{ i+1 }}</option>
              }
            </select>
          </div>
        </div>
        <p class="hint">Daty zostaną wstawione w bieżącym zakresie grafiku. Weekend/święta są brane z konfiguracji.</p>
      </div>
      <div class="modal-actions">
        <button class="btn" (click)="closeTemplateModal()">Anuluj</button>
        <button class="btn btn-primary" (click)="applyTemplateToEmployee()">Zastosuj</button>
      </div>
    </div>
  }
</div>